generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
}

// ─── User & Auth ─────────────────────────────────────────────────
model User {
  id             String    @id @default(cuid())
  email          String    @unique
  passwordHash   String?
  firstName      String
  lastName       String
  avatar         String?
  phone          String?
  bio            String?
  role           String    @default("mentee") // admin, mentor, mentee
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  mentorProfile  MentorProfile?
  menteeProfile  MenteeProfile?
  accounts       Account[]

  // Relations
  mentorships        Mentorship[]     @relation("MentorUser")
  menteeships        MentorshipMentee[]
  meetingsCreated    Meeting[]        @relation("MeetingCreator")
  attendances        Attendance[]
  minutesCreated     MeetingMinutes[] @relation("MinutesAuthor")
  goalsCreated       Goal[]           @relation("GoalCreator")
  feedbackGiven      Feedback[]       @relation("FeedbackFrom")
  feedbackReceived   Feedback[]       @relation("FeedbackTo")
  resourcesUploaded  Resource[]
  notifications      Notification[]
  portfolios         Portfolio[]
  availabilities     Availability[]

  @@index([role])
  @@index([email])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model MentorProfile {
  id          String   @id @default(cuid())
  userId      String   @unique
  company     String?
  jobTitle    String?
  expertise   String?  // JSON array stored as string
  experience  String?
  linkedIn    String?
  maxMentees  Int      @default(6)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model MenteeProfile {
  id                    String    @id @default(cuid())
  userId                String    @unique
  studentId             String?  // MSSV
  major                 String?
  year                  Int?     // 1, 2, 3, 4
  careerGoals           String?
  skills                String?  // JSON array stored as string
  strengths             String?
  weaknesses            String?
  currentChallenges     String?  // Current difficulties
  expectations          String?  // Expectations from program
  background            String?  // Personal background
  experience            String?  // Personal/work experience
  endGoals              String?  // Desired outcomes after program
  isOnboardingComplete  Boolean  @default(false)
  onboardingCompletedAt DateTime?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ─── Program & Mentorship ────────────────────────────────────────
model ProgramCycle {
  id          String   @id @default(cuid())
  name        String
  description String?
  startDate   DateTime
  endDate     DateTime
  status      String   @default("active") // draft, active, completed, archived
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  mentorships Mentorship[]
}

model Mentorship {
  id             String   @id @default(cuid())
  mentorId       String
  type           String   @default("one_on_one") // one_on_one, group
  status         String   @default("pending") // pending, active, completed, cancelled
  programCycleId String
  startDate      DateTime
  endDate        DateTime
  maxMentees     Int      @default(1)
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  mentor       User               @relation("MentorUser", fields: [mentorId], references: [id])
  programCycle ProgramCycle        @relation(fields: [programCycleId], references: [id])
  mentees      MentorshipMentee[]
  meetings     Meeting[]
  goals        Goal[]
  feedbacks    Feedback[]

  @@index([mentorId])
  @@index([programCycleId])
  @@index([status])
}

model MentorshipMentee {
  id           String   @id @default(cuid())
  mentorshipId String
  menteeId     String
  joinedAt     DateTime @default(now())
  status       String   @default("active") // active, withdrawn, completed

  mentorship Mentorship @relation(fields: [mentorshipId], references: [id], onDelete: Cascade)
  mentee     User       @relation(fields: [menteeId], references: [id])

  @@unique([mentorshipId, menteeId])
  @@index([menteeId])
}

// ─── Meetings & Attendance ───────────────────────────────────────
model Meeting {
  id           String    @id @default(cuid())
  mentorshipId String
  creatorId    String
  title        String
  description  String?
  type         String    @default("offline") // offline, online
  meetingType  String    @default("session") // session, workshop, checkin
  scheduledAt  DateTime
  duration     Int       @default(60) // minutes
  location     String?
  meetingUrl   String?
  status       String    @default("scheduled") // scheduled, in_progress, completed, cancelled
  qrToken      String?   @unique
  qrExpiresAt  DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  mentorship  Mentorship       @relation(fields: [mentorshipId], references: [id])
  creator     User             @relation("MeetingCreator", fields: [creatorId], references: [id])
  attendances Attendance[]
  minutes     MeetingMinutes[]

  @@index([mentorshipId])
  @@index([scheduledAt])
  @@index([status])
}

model Attendance {
  id              String    @id @default(cuid())
  meetingId       String
  userId          String
  checkInTime     DateTime?
  checkInLat      Float?
  checkInLng      Float?
  deviceHash      String?
  status          String    @default("absent") // present, absent, late, excused
  verifiedAt      DateTime?
  createdAt       DateTime  @default(now())

  meeting Meeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id])

  @@unique([meetingId, userId])
  @@index([userId])
}

model MeetingMinutes {
  id            String   @id @default(cuid())
  meetingId     String
  authorId      String
  agenda        String?
  keyPoints     String?  // Rich text
  actionItems   String?  // JSON array stored as string
  outcome       String?  // productive, average, needs_improvement
  attachments   String?  // JSON array of file URLs
  status        String   @default("draft") // draft, submitted, approved
  submittedAt   DateTime?
  approvedAt    DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  meeting Meeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  author  User    @relation("MinutesAuthor", fields: [authorId], references: [id])

  @@index([meetingId])
}

// ─── Goals & Progress ────────────────────────────────────────────
model Goal {
  id           String    @id @default(cuid())
  mentorshipId String
  creatorId    String
  title        String
  description  String?
  category     String    @default("skill") // skill, knowledge, network, project, career
  targetValue  Int?      // e.g., 100 for percentage
  currentValue Int       @default(0)
  unit         String?   // percent, count, etc.
  status       String    @default("in_progress") // not_started, in_progress, completed, paused
  priority     String    @default("medium") // low, medium, high
  dueDate      DateTime?
  completedAt  DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  mentorship    Mentorship       @relation(fields: [mentorshipId], references: [id])
  creator       User             @relation("GoalCreator", fields: [creatorId], references: [id])
  progressNotes ProgressNote[]

  @@index([mentorshipId])
  @@index([status])
}

model ProgressNote {
  id        String   @id @default(cuid())
  goalId    String
  note      String
  value     Int?     // progress value at this point
  createdAt DateTime @default(now())

  goal Goal @relation(fields: [goalId], references: [id], onDelete: Cascade)

  @@index([goalId])
}

// ─── Feedback ────────────────────────────────────────────────────
model Feedback {
  id           String   @id @default(cuid())
  mentorshipId String
  fromUserId   String
  toUserId     String
  type         String   @default("session") // session, monthly, end_of_program
  rating       Int?     // 1-5
  communication Int?    // 1-5
  engagement   Int?     // 1-5
  content      String?
  strengths    String?
  improvements String?
  isAnonymous  Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  mentorship Mentorship @relation(fields: [mentorshipId], references: [id])
  fromUser   User       @relation("FeedbackFrom", fields: [fromUserId], references: [id])
  toUser     User       @relation("FeedbackTo", fields: [toUserId], references: [id])

  @@index([mentorshipId])
  @@index([fromUserId])
  @@index([toUserId])
}

// ─── Resources ───────────────────────────────────────────────────
model Resource {
  id           String   @id @default(cuid())
  title        String
  description  String?
  type         String   @default("file") // file, link, document
  fileUrl      String?
  linkUrl      String?
  fileName     String?
  fileSize     Int?
  mimeType     String?
  category     String?
  tags         String?  // JSON array stored as string
  visibility   String   @default("public") // public, private, group
  uploadedById String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  uploadedBy User @relation(fields: [uploadedById], references: [id])

  @@index([category])
  @@index([uploadedById])
}

// ─── Portfolio ───────────────────────────────────────────────────
model Portfolio {
  id                 String    @id @default(cuid())
  menteeId           String
  personalityMbti    String?
  personalityDisc    String?
  personalityHolland String?
  competencies       String?   // JSON: { communication: 7, leadership: 6, ... }
  shortTermGoals     String?   // JSON array
  longTermGoals      String?   // JSON array
  initialCompletedAt DateTime?
  finalGoalsAchieved Int?      // percentage 0-100
  finalSkillsGained  String?   // JSON array
  finalMentorFeedback String?
  finalSelfAssessment String?
  finalRecommendations String?
  finalCompletedAt   DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  mentee User @relation(fields: [menteeId], references: [id])

  @@index([menteeId])
}

// ─── Availability & Booking ─────────────────────────────────────
model Availability {
  id          String   @id @default(cuid())
  userId      String
  dayOfWeek   Int      // 0=Sunday, 1=Monday, ..., 6=Saturday
  startTime   String   // "09:00"
  endTime     String   // "17:00"
  duration    Int      @default(60) // meeting duration in minutes
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// ─── Notifications ───────────────────────────────────────────────
model Notification {
  id        String    @id @default(cuid())
  userId    String
  title     String
  message   String
  type      String    @default("info") // info, success, warning, error
  link      String?
  isRead    Boolean   @default(false)
  readAt    DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([createdAt])
}
